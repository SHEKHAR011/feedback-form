---
import AnonymousLayout from "../layouts/AnonymousLayout.astro";
import axios from "axios";

let status = "";
if (Astro.request.method === "POST") {
  try {
    const body = await Astro.request.text();
    const data = JSON.parse(body);
    const { message, category } = data;

    await axios.post("http://localhost:4000/api/feedback", { message, category });
    status = "âœ… Feedback submitted!";
  } catch {
    status = "âŒ Error submitting feedback.";
  }
}
---

<AnonymousLayout title="Anonymous Feedback">
  <div class="h-screen flex items-center justify-center px-4 py-6 sm:p-6">
    <main class="w-full max-w-lg relative">
      <!-- Subtle white glow behind card -->
      <div class="absolute inset-0 bg-gradient-to-tr from-white/10 to-gray-500/5 blur-3xl rounded-3xl"></div>

      <!-- Monochrome glass card -->
      <div class="relative backdrop-blur-xl bg-white/5 border border-white/20 rounded-2xl sm:rounded-3xl shadow-2xl p-6 sm:p-8 transition duration-500 hover:scale-[1.02]">
        <div class="text-center mb-6 sm:mb-8">
          <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2 tracking-tight">
            Anonymous Feedback
          </h1>
          <p class="text-gray-400 text-xs sm:text-sm">Your thoughts matter â€” share them freely ğŸ–‹ï¸</p>
        </div>

        <form id="feedbackForm" class="space-y-4 sm:space-y-5">
          <div>
            <label for="message" class="block text-sm font-semibold text-gray-300 mb-1">Your Feedback</label>
            <textarea
              id="message"
              placeholder="Write your feedback..."
              required
              class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base text-white placeholder-gray-500 bg-black/30 border border-white/20 rounded-xl focus:ring-2 focus:ring-white focus:border-transparent transition duration-200 resize-none"
              rows="4"
            ></textarea>
          </div>

          <div>
            <label for="category" class="block text-sm font-semibold text-gray-300 mb-1">Category</label>
            <select
              id="category"
              required
              class="w-full px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base text-white bg-black/30 border border-white/20 rounded-xl focus:ring-2 focus:ring-white focus:border-transparent transition duration-200 appearance-none cursor-pointer"
              style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27white%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.25em 1.25em;"
            >
              <option value="" disabled selected class="bg-gray-900">Select a category...</option>
              <option value="Suggestion" class="bg-gray-900">ğŸ’¡ Suggestion</option>
              <option value="Complaint" class="bg-gray-900">âš ï¸ Complaint</option>
              <option value="Praise" class="bg-gray-900">ğŸ‘ Praise</option>
              <option value="Others" class="bg-gray-900">ğŸ“ Others</option>
            </select>
          </div>

          <button
            type="submit"
            class="w-full py-2.5 sm:py-3 text-sm sm:text-base font-semibold rounded-xl text-black bg-white shadow-lg hover:bg-gray-200 transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-xl"
          >
            Submit Feedback ğŸ“¨
          </button>
        </form>

        <div id="status" class="mt-4 sm:mt-6 text-center text-xs sm:text-sm font-medium min-h-[1.5rem]">
          {status && (
            <span class={`${status.includes('âœ…') ? 'text-green-400' : 'text-red-400'}`}>
              {status}
            </span>
          )}
        </div>
      </div>
    </main>

    <script>
      const form = document.getElementById('feedbackForm') as HTMLFormElement | null;
      const statusElement = document.getElementById('status');
      
      if (form && statusElement) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const messageEl = document.getElementById('message') as HTMLTextAreaElement | null;
          const categoryEl = document.getElementById('category') as HTMLSelectElement | null;
          
          if (!messageEl || !categoryEl) return;
          
          const message = messageEl.value;
          const category = categoryEl.value;

          try {
            const response = await fetch('http://localhost:4000/api/feedback', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message, category }),
            });

            if (response.ok) {
              statusElement.innerHTML = '<span class="text-green-400">âœ… Feedback submitted!</span>';
              form.reset();
            } else {
              statusElement.innerHTML = '<span class="text-red-400">âŒ Error submitting feedback.</span>';
            }
          } catch (error) {
            statusElement.innerHTML = '<span class="text-red-400">âŒ Server error.</span>';
          }
        });
      }
    </script>
  </div>
</AnonymousLayout>
